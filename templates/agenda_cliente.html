{% extends "base.html" %}
{% block content %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">ðŸ“… Agenda do Cliente: {{ cliente_nome }}</h3>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger fw-semibold">Sair</a>
    </div>

    <!-- Unidades Vinculadas -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            Unidades Vinculadas
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                {% for u in unidades %}
                    <span class="badge bg-info text-dark fs-6 px-3 py-2">{{ u[1] }}</span>
                {% else %}
                    <p class="text-muted mb-0">Nenhuma unidade cadastrada para este cliente.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- CalendÃ¡rio -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white fw-bold">CalendÃ¡rio de Visitas</div>
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Legenda -->
    <div class="mt-4">
        <h6 class="fw-bold">Legenda de Status:</h6>
        <div class="d-flex flex-wrap gap-3 mt-2">
            <div><span class="badge bg-warning text-dark">Pendente ConfirmaÃ§Ã£o</span></div>
            <div><span class="badge bg-success">Confirmado</span></div>
            <div><span class="badge bg-danger">Cancelado</span></div>
            <div><span class="badge text-light" style="background-color:#e67e22;">Reagendado</span></div>
        </div>
    </div>
</div>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    const clienteId = "{{ session.get('cliente_id') }}";

    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        themeSystem: 'bootstrap5',
        height: 'auto',
        initialView: 'dayGridMonth',
        selectable: false,
        editable: false,
        events: '/api/agendamentos',

        eventContent: function (arg) {
            const e = arg.event.extendedProps;
            // Mostra apenas eventos do cliente logado
            if (e.cliente_id != clienteId) return false;
            return { html: `<div>${arg.event.title}</div>` };
        },

        eventDidMount: function (info) {
            const e = info.event.extendedProps;
            if (e && e.cliente_id == clienteId) {
                new bootstrap.Tooltip(info.el, {
                    title: `
                        <b>Cliente:</b> ${e.cliente}<br>
                        <b>Unidade:</b> ${e.unidade}<br>
                        <b>TÃ©cnico:</b> ${e.tecnico || ''}<br>
                        <b>Status:</b> ${e.status}<br>
                        <b>Data:</b> ${info.event.startStr}<br>
                        <b>Obs:</b> ${e.observacoes || ''}
                    `,
                    html: true,
                    placement: 'top',
                    trigger: 'hover'
                });
            }
        }
    });

    calendar.render();
});
</script>
{% endblock %}
